<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WieAct â€¢ ESP8266 IoT Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><text x='0' y='24' font-size='24'>ðŸ“¡</text></svg>" />
    <style>
      :root {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #1f2933;
        background: #f3f4f6;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      main {
        width: min(960px, 94vw);
        background: #fff;
        padding: 2.5rem 2rem 2rem;
        border-radius: 18px;
        box-shadow: 0 12px 28px -16px rgba(15, 23, 42, 0.35);
        display: grid;
        gap: 2rem;
      }

      header {
        display: flex;
        flex-wrap: wrap;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.5rem 1rem;
      }

      h1 {
        font-size: clamp(1.75rem, 4vw, 2.4rem);
        margin: 0;
      }

      #meta {
        color: #64748b;
        font-size: 0.95rem;
      }

      #metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 1rem;
      }

      .metric-card {
        padding: 1rem 1.25rem;
        border-radius: 14px;
        background: linear-gradient(135deg, #eef2ff, #f8fafc);
        border: 1px solid rgba(148, 163, 184, 0.24);
      }

      .metric-card h2 {
        margin: 0 0 0.25rem;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #475569;
      }

      .metric-card p {
        margin: 0;
        font-size: 1.8rem;
        font-weight: 600;
        color: #0f172a;
      }

      #actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: flex-end;
      }

      button {
        appearance: none;
        border: none;
        border-radius: 999px;
        padding: 0.65rem 1.4rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 120ms ease, box-shadow 120ms ease;
      }

      button:active {
        transform: translateY(1px);
      }

      #refresh-btn {
        background: #2563eb;
        color: #fff;
        box-shadow: 0 10px 20px -12px rgba(37, 99, 235, 0.75);
      }

      #clear-btn {
        background: #e11d48;
        color: #fff;
        box-shadow: 0 10px 20px -12px rgba(190, 24, 60, 0.75);
      }

      #qr-btn {
        background: #8b5cf6;
        color: #fff;
        box-shadow: 0 10px 20px -12px rgba(139, 92, 246, 0.75);
      }

      #status {
        font-size: 0.9rem;
        color: #475569;
      }

      /* QR Code Dialog Styles */
      .dialog-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
      }

      .dialog-overlay.active {
        display: flex;
      }

      .dialog-content {
        background: #fff;
        border-radius: 18px;
        padding: 2rem;
        max-width: 90vw;
        max-height: 90vh;
        box-shadow: 0 20px 40px -16px rgba(15, 23, 42, 0.5);
        position: relative;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .dialog-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .dialog-header h2 {
        margin: 0;
        font-size: 1.5rem;
        color: #1f2933;
      }

      .close-btn {
        background: #f1f5f9;
        color: #475569;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.5rem;
        transition: background 0.2s ease;
        padding: 0;
      }

      .close-btn:hover {
        background: #e2e8f0;
      }

      .qr-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }

      .qr-container img {
        max-width: 400px;
        height: auto;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
      }

      .qr-container p {
        color: #64748b;
        font-size: 0.95rem;
        text-align: center;
        margin: 0;
      }

      canvas {
        width: 100% !important;
        max-height: 360px;
      }

      footer {
        font-size: 0.8rem;
        color: #94a3b8;
        text-align: center;
      }

      @media (max-width: 640px) {
        main {
          padding: 1.75rem 1.25rem 1.25rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <div>
          <h1>ESP8266 Greenhouse</h1>
          <p id="meta">Waiting for readingsâ€¦</p>
        </div>
        <div id="actions">
          <button id="qr-btn" type="button">ðŸ“± QR Code</button>
          <button id="refresh-btn" type="button">Refresh</button>
          <button id="clear-btn" type="button">Clear history</button>
        </div>
      </header>

      <section id="metrics">
        <article class="metric-card">
          <h2>Temperature</h2>
          <p id="temp">-- Â°C</p>
        </article>
        <article class="metric-card">
          <h2>Humidity</h2>
          <p id="hum">-- %</p>
        </article>
        <article class="metric-card">
          <h2>Soil Moisture</h2>
          <p id="soil">--</p>
        </article>
        <article class="metric-card">
          <h2>Soil Raw</h2>
          <p id="soilRaw">--</p>
        </article>
      </section>

      <section>
        <div id="chart-controls" style="margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: center;">
          <span style="font-weight: 600; color: #475569;">Chart Data:</span>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="toggle-temp" checked style="cursor: pointer; width: 18px; height: 18px;">
            <span style="color: #ef4444; font-weight: 500;">Temperature</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="toggle-humidity" checked style="cursor: pointer; width: 18px; height: 18px;">
            <span style="color: #2563eb; font-weight: 500;">Humidity</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="toggle-moisture" checked style="cursor: pointer; width: 18px; height: 18px;">
            <span style="color: #10b981; font-weight: 500;">Soil Moisture</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="checkbox" id="toggle-soilRaw" style="cursor: pointer; width: 18px; height: 18px;">
            <span style="color: #f59e0b; font-weight: 500;">Soil Raw</span>
          </label>
        </div>
        <canvas id="chart" aria-label="Sensor readings over time"></canvas>
      </section>

      <footer>Real-time updates via WebSocket. Status: <span id="status">connecting...</span>.</footer>
    </main>

    <!-- QR Code Dialog -->
    <div class="dialog-overlay" id="qr-dialog">
      <div class="dialog-content">
        <div class="dialog-header">
          <h2>Scan to Access Dashboard</h2>
          <button class="close-btn" id="close-dialog" aria-label="Close dialog">Ã—</button>
        </div>
        <div class="qr-container">
          <img src="/qrcode.png" alt="QR Code to access the dashboard" />
          <p>Scan this QR code with your mobile device to access the dashboard</p>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const statusEl = document.getElementById('status');
      const metaEl = document.getElementById('meta');
      const tempEl = document.getElementById('temp');
      const humEl = document.getElementById('hum');
      const soilEl = document.getElementById('soil');
      const soilRawEl = document.getElementById('soilRaw');
      const refreshBtn = document.getElementById('refresh-btn');
      const clearBtn = document.getElementById('clear-btn');
      const qrBtn = document.getElementById('qr-btn');
      const qrDialog = document.getElementById('qr-dialog');
      const closeDialogBtn = document.getElementById('close-dialog');
      const chartCtx = document.getElementById('chart');
      
      const toggleTemp = document.getElementById('toggle-temp');
      const toggleHumidity = document.getElementById('toggle-humidity');
      const toggleMoisture = document.getElementById('toggle-moisture');
      const toggleSoilRaw = document.getElementById('toggle-soilRaw');

      let chart;
      let ws;
      let allReadings = [];

      const formatValue = (value, unit = '') => {
        if (typeof value !== 'number' || Number.isNaN(value)) {
          return `-- ${unit}`.trim();
        }
        return `${value.toFixed(1)} ${unit}`.trim();
      };

      const toLocaleLabel = (isoString) => {
        const date = new Date(isoString);
        if (Number.isNaN(date.getTime())) {
          return 'unknown';
        }
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      };

      const applyMetrics = (entries = []) => {
        if (!entries.length) {
          metaEl.textContent = 'Waiting for readingsâ€¦';
          tempEl.textContent = '-- Â°C';
          humEl.textContent = '-- %';
          soilEl.textContent = '--';
          soilRawEl.textContent = '--';
          return;
        }

        metaEl.textContent = `Total readings: ${entries.length}`;
        const latest = entries.at(-1);
        tempEl.textContent = formatValue(latest.temp, 'Â°C');
        humEl.textContent = formatValue(latest.humidity, '%');
        soilEl.textContent = formatValue(latest.moisture);
        soilRawEl.textContent = formatValue(latest.soilRaw);
        
        // Update status with live indicator
        statusEl.textContent = `${new Date().toLocaleTimeString()} ðŸŸ¢ live`;
      };

      const renderChart = (entries = [], animate = true) => {
        const labels = entries.map((entry) => toLocaleLabel(entry.createdAt));
        const temperature = entries.map((entry) => entry.temp);
        const humidity = entries.map((entry) => entry.humidity);
        const moisture = entries.map((entry) => entry.moisture);
        const soilRaw = entries.map((entry) => entry.soilRaw || 0);

        const allDatasets = [
          {
            label: 'Temperature (Â°C)',
            data: temperature,
            borderColor: '#ef4444',
            backgroundColor: 'rgba(239, 68, 68, 0.15)',
            tension: 0.35,
            fill: true,
            hidden: !toggleTemp.checked
          },
          {
            label: 'Humidity (%)',
            data: humidity,
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.18)',
            tension: 0.35,
            fill: true,
            hidden: !toggleHumidity.checked
          },
          {
            label: 'Soil Moisture',
            data: moisture,
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.18)',
            tension: 0.35,
            fill: true,
            hidden: !toggleMoisture.checked
          },
          {
            label: 'Soil Raw',
            data: soilRaw,
            borderColor: '#f59e0b',
            backgroundColor: 'rgba(245, 158, 11, 0.18)',
            tension: 0.35,
            fill: true,
            hidden: !toggleSoilRaw.checked
          }
        ];

        if (!chart) {
          chart = new Chart(chartCtx, {
            type: 'line',
            data: { labels, datasets: allDatasets },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: {
                duration: 750,
                easing: 'easeInOutQuart'
              },
              plugins: {
                legend: {
                  display: true,
                  labels: {
                    usePointStyle: true
                  }
                },
                tooltip: {
                  mode: 'index',
                  intersect: false
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  ticks: {
                    precision: 1
                  }
                }
              }
            }
          });
        } else {
          chart.data.labels = labels;
          chart.data.datasets = allDatasets;
          chart.update(animate ? 'active' : 'none');
        }
      };

      const appendNewReading = (newReading) => {
        const newLabel = toLocaleLabel(newReading.createdAt);
        
        // Add new label
        chart.data.labels.push(newLabel);
        
        // Add new data points to each dataset
        chart.data.datasets[0].data.push(newReading.temp);
        chart.data.datasets[1].data.push(newReading.humidity);
        chart.data.datasets[2].data.push(newReading.moisture);
        chart.data.datasets[3].data.push(newReading.soilRaw || 0);
        
        // Update visibility based on toggles
        chart.data.datasets[0].hidden = !toggleTemp.checked;
        chart.data.datasets[1].hidden = !toggleHumidity.checked;
        chart.data.datasets[2].hidden = !toggleMoisture.checked;
        chart.data.datasets[3].hidden = !toggleSoilRaw.checked;
        
        // Animate the update
        chart.update('active');
      };

      const refreshData = async () => {
        try {
          statusEl.textContent = 'loadingâ€¦';
          const response = await fetch('/api/data');
          if (!response.ok) {
            throw new Error(`Failed to load data (${response.status})`);
          }
          const entries = await response.json();
          allReadings = entries;
          applyMetrics(entries);
          renderChart(entries);
        } catch (error) {
          console.error(error);
          statusEl.textContent = 'failed';
        }
      };

      const clearData = async () => {
        clearBtn.disabled = true;
        try {
          const response = await fetch('/api/data/clear', {
            method: 'POST'
          });
          if (!response.ok && response.status !== 204) {
            throw new Error('Unable to clear data');
          }
          allReadings = [];
          applyMetrics([]);
          renderChart([]);
        } catch (error) {
          console.error(error);
          statusEl.textContent = 'clear failed';
        } finally {
          clearBtn.disabled = false;
        }
      };

      // WebSocket connection for real-time updates
      const connectWebSocket = () => {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}`;
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = () => {
          console.log('WebSocket connected');
          statusEl.textContent = 'connected ðŸŸ¢ live';
        };
        
        ws.onmessage = (event) => {
          const message = JSON.parse(event.data);
          
          if (message.type === 'init') {
            // Initial data load
            allReadings = message.data;
            applyMetrics(allReadings);
            renderChart(allReadings, false);
          } else if (message.type === 'newReading') {
            // New reading received - add to array and update with animation
            allReadings.push(message.data);
            applyMetrics(allReadings);
            
            // Use append function for smooth animation
            if (chart) {
              appendNewReading(message.data);
            } else {
              renderChart(allReadings);
            }
          } else if (message.type === 'clear') {
            // Data was cleared
            allReadings = [];
            applyMetrics([]);
            renderChart([], false);
          }
        };
        
        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
          statusEl.textContent = 'connection error ðŸ”´';
        };
        
        ws.onclose = () => {
          console.log('WebSocket disconnected, reconnecting...');
          statusEl.textContent = 'reconnecting...';
          // Reconnect after 2 seconds
          setTimeout(connectWebSocket, 2000);
        };
      };

      refreshBtn.addEventListener('click', refreshData);
      clearBtn.addEventListener('click', clearData);
      
      // QR Code Dialog handlers
      qrBtn.addEventListener('click', () => {
        qrDialog.classList.add('active');
      });

      closeDialogBtn.addEventListener('click', () => {
        qrDialog.classList.remove('active');
      });

      // Close dialog when clicking outside the content
      qrDialog.addEventListener('click', (e) => {
        if (e.target === qrDialog) {
          qrDialog.classList.remove('active');
        }
      });

      // Close dialog with Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && qrDialog.classList.contains('active')) {
          qrDialog.classList.remove('active');
        }
      });
      
      // Add event listeners for chart toggles
      toggleTemp.addEventListener('change', () => renderChart(allReadings, false));
      toggleHumidity.addEventListener('change', () => renderChart(allReadings, false));
      toggleMoisture.addEventListener('change', () => renderChart(allReadings, false));
      toggleSoilRaw.addEventListener('change', () => renderChart(allReadings, false));

      // Initialize WebSocket connection
      connectWebSocket();
    </script>
  </body>
</html>
